<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard Prolanis</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- DataTables -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"/>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding-top:70px; }
.card { border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.2s; }
.card:hover { transform: translateY(-3px); }
h2 { font-weight: 600; margin-bottom: 30px; }
.dt-filter { margin-bottom: 15px; max-width: 100%; }
#loadingSpinner { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:9999; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">Dashboard Prolanis</a>
  </div>
</nav>

<!-- Spinner Loading -->
<div id="loadingSpinner">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<div class="container-fluid px-3">
  <!-- Notifikasi -->
  <div class="alert alert-success d-flex align-items-center shadow small" role="alert">
    <i class="fas fa-check-circle me-2"></i>
    <div>Data berdasarkan register Erm sampai dengan bulan Juli 2025</div>
  </div>

  <!-- Kartu Ringkasan -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-sm-6 col-md-3">
      <div class="card p-3 text-center bg-primary text-white">
        <h6><i class="fas fa-users me-2"></i>Total Pasien</h6>
        <h3 id="totalPasien">0</h3>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3">
      <div class="card p-3 text-center bg-success text-white">
        <h6><i class="fas fa-file-medical me-2"></i>DM Ada</h6>
        <h3 id="dmAda">0</h3>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3">
      <div class="card p-3 text-center bg-warning text-dark">
        <h6><i class="fas fa-heartbeat me-2"></i>HT Ada</h6>
        <h3 id="htAda">0</h3>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3">
      <div class="card p-3 text-center bg-danger text-white">
        <h6><i class="fas fa-user-slash me-2"></i>Tidak Aktif</h6>
        <h3 id="tidakAktif">0</h3>
      </div>
    </div>
  </div>

  <!-- Grafik -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card p-3">
        <div style="height:300px;">
          <canvas id="chartDesa"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter + Unduh -->
  <div class="row mb-3 g-2">
    <div class="col-12 col-md-6">
      <select id="statusFilter" class="form-select dt-filter">
        <option value="">-- Filter Status --</option>
        <option value="Ada">Ada</option>
        <option value="Tidak Ada">Tidak Ada</option>
      </select>
    </div>
    <div class="col-12 col-md-6 text-md-end">
      <a href="https://drive.google.com/uc?export=download&id=1m5Ed2T669SqHxCqzyLBmKjP6URxP2AHb" class="btn btn-primary w-100 w-md-auto">
        <i class="fas fa-file-archive me-2"></i> Unduh Laporan
      </a>
    </div>
  </div>

  <!-- Tabel -->
  <div class="row">
    <div class="col-12">
      <div class="card p-3">
        <h5 class="text-center mb-3">Data Pasien Aktif 3 Bulan</h5>
        <div class="table-responsive">
          <table id="dataTable" class="table table-striped table-hover" style="width:100%">
            <thead><tr id="headerRow"></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwnTfP3ayfzlQf2ibPGnNNZzKfqTpXyZfqJPFitexyeg7zNLzNqvqeqU1O4j83H2hzy-A/exec";
const fixedDesaOrder = ["Karangsoko","Kelutan","Ngantru","Sambirejo","Sumbergedong","Surodakan","Tamanan"];

function formatDate(value) {
    if(!value) return "";
    const date = new Date(value);
    if(isNaN(date)) return value; 
    return date.toLocaleString('id-ID', { month: 'short', year: 'numeric' });
}

async function loadData() {
  const spinner = document.getElementById('loadingSpinner');
  spinner.style.display = 'block';

  try {
    const res = await fetch(WEB_APP_URL);
    const json = await res.json();
    if(!json.success) return;

    const data = json.data;
    const headers = json.headers;

    // Ringkasan
    document.getElementById('totalPasien').textContent = data.length;
    let dmAda=0, htAda=0, tidakAktif=0;
    const desaCounts = {};
    data.forEach(r=>{
        if(r.Status === "Ada") {
            if(r.Diagnosa === "E11.9") dmAda++;
            if(r.Diagnosa === "I10") htAda++;
        } else {
            tidakAktif++;
        }
        const desaNormalized = r.Desa.trim().toLowerCase();
        const desa = fixedDesaOrder.find(d => d.toLowerCase() === desaNormalized) || "Lainnya";
        desaCounts[desa] = (desaCounts[desa] || 0) + 1;
    });
    document.getElementById('dmAda').textContent = dmAda;
    document.getElementById('htAda').textContent = htAda;
    document.getElementById('tidakAktif').textContent = tidakAktif;

    // Tabel Header
    const headerRow = document.getElementById('headerRow');
    headerRow.innerHTML = '';
    headers.forEach(h=>{
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
    });

    // Tabel Body
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    data.forEach(r=>{
      const tr = document.createElement('tr');
      headers.forEach(h=>{
        const td = document.createElement('td');
        if(h === "Mulai 3Bln" || h === "Akhir 3Bln") {
            td.textContent = formatDate(r[h]);
        } else {
            td.textContent = r[h];
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    // DataTable
    if ($.fn.DataTable.isDataTable('#dataTable')) {
        $('#dataTable').DataTable().destroy();
    }
    const table = $('#dataTable').DataTable({ 
      paging:true, searching:true, info:true, responsive:true 
    });

    // Filter Status
    $('#statusFilter').on('change', function(){
      table.column(headers.indexOf("Status")).search(this.value).draw();
    });

    // Grafik Desa
    const chartLabels = [...fixedDesaOrder, "Lainnya"];
    const chartData = [...fixedDesaOrder.map(d=>desaCounts[d]||0), desaCounts["Lainnya"]||0];
    const ctx = document.getElementById('chartDesa').getContext('2d');
    if(window.desaChart) window.desaChart.destroy(); // reset jika reload
    window.desaChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Jumlah Pasien',
                data: chartData,
                backgroundColor: ['#0d6efd','#6f42c1','#198754','#fd7e14','#0dcaf0','#ffc107','#dc3545','#adb5bd']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Jumlah Pasien per Desa' }
            },
            scales: { y: { beginAtZero: true } }
        }
    });

  } catch(e) {
    console.error(e);
  } finally {
    spinner.style.display = 'none';
  }
}

loadData();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
