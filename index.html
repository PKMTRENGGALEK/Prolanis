<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard Prolanis</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- DataTables -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"/>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background-color: #f8fafc;
  padding-top: 70px;
}
.navbar {
  background: linear-gradient(90deg,#304061,#ece2fd);
}
.navbar .navbar-brand {
  color: #fff !important;
  font-weight: 700;
}
.card {
  border-radius: 15px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  transition: all 0.25s ease;
}
.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 24px rgba(0,0,0,0.12);
}
.card h6 {
  font-weight: 600;
  margin-bottom: .5rem;
}
#loadingSpinner {
  position:fixed; top:50%; left:50%;
  transform:translate(-50%,-50%);
  z-index:9999;
}
.alert {
  border-radius: 10px;
  font-size: 0.9rem;
}
.table {
  border-radius: 10px;
  overflow: hidden;
}
.table thead th {
  background-color: #f1f5f9;
}
h5 {
  font-weight: 600;
  color: #374151;
}
  #donutContainer {
      width: 400px;
      margin: auto;
    }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg shadow-sm fixed-top">
  <div class="container">
    <a class="navbar-brand" href="#"><i class="fas fa-hospital-user me-2"></i>Dashboard Prolanis</a>
  </div>
</nav>

<!-- Spinner Loading -->
<div id="loadingSpinner">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<div class="container py-4">

  <!-- Notifikasi -->
  <div class="alert alert-info d-flex align-items-center shadow-sm mb-4" role="alert">
    <i class="fas fa-info-circle me-2"></i>
    <div>Data berdasarkan register Erm sampai dengan <b>bulan Juli 2025</b></div>
  </div>

  <!-- Kartu Ringkasan -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-sm-6 col-md-3">
      <div class="card p-3 text-center bg-primary text-white">
        <h6><i class="fas fa-users me-2"></i>Total Pasien</h6>
        <h2 id="totalPasien">0</h2>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3">
      <div class="card p-3 text-center bg-success text-white">
        <h6><i class="fas fa-file-medical me-2"></i>Pasien DM</h6>
        <h2 id="dmAda">0</h2>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3">
      <div class="card p-3 text-center bg-warning text-dark">
        <h6><i class="fas fa-heartbeat me-2"></i>Pasien HT</h6>
        <h2 id="htAda">0</h2>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3">
      <div class="card p-3 text-center bg-danger text-white">
        <h6><i class="fas fa-user-slash me-2"></i>Tidak Aktif</h6>
        <h2 id="tidakAktif">0</h2>
      </div>
    </div>
  </div>

  <!-- Grafik -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card p-3">
        <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Distribusi Pasien per Desa</h5>
        <div style="height:300px;">
          <canvas id="chartDesa"></canvas>
        </div>
      </div>
    </div>
  </div>
   <!-- Grafik Donut -->
  <div class="row mb-4">
    <div class="col-12 col-md-6 mx-auto">
      <div class="card p-3">
        <h5 class="mb-3 text-center"><i class="fas fa-chart-pie me-2"></i>Perbandingan Data ERM vs BPJS</h5>
        <div id="donutContainer" style="height:300px;">
          <canvas id="donutChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <!-- Filter + Unduh -->
  <div class="row mb-3 g-2">
    <div class="col-12 col-md-6">
      <select id="statusFilter" class="form-select shadow-sm">
        <option value="">-- Filter Status --</option>
        <option value="Ada">Ada</option>
        <option value="Tidak Ada">Tidak Ada</option>
      </select>
    </div>
    <div class="col-12 col-md-6 text-md-end">
      <a href="https://drive.google.com/uc?export=download&id=1m5Ed2T669SqHxCqzyLBmKjP6URxP2AHb" class="btn btn-primary shadow-sm">
        <i class="fas fa-file-archive me-2"></i> Unduh Laporan
      </a>
    </div>
  </div>

  <!-- Tabel -->
  <div class="row">
    <div class="col-12">
      <div class="card p-3">
        <h5 class="text-center mb-3"><i class="fas fa-table me-2"></i>Data Pasien Aktif 3 Bulan</h5>
        <div class="table-responsive">
          <table id="dataTable" class="table table-striped table-hover align-middle" style="width:100%">
            <thead class="table-light"><tr id="headerRow"></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Footer -->
<footer class="bg-light text-center text-muted py-3 mt-5 small">
  <div class="container">
    <span>Created by <b>@yoga</b> â€¢ 2025 | pkm-trenggalek</span>
  </div>
</footer>
<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbymcDWLrHda94e-oJTT3bWTryEwtxuL_ULJDJnhNfltwHvsPON5m6ROnESwE7jM5LYrXA/exec";
const fixedDesaOrder = ["Karangsoko","Kelutan","Ngantru","Sambirejo","Sumbergedong","Surodakan","Tamanan"];

function formatDate(value) {
    if(!value) return "";
    const date = new Date(value);
    if(isNaN(date)) return value; 
    return date.toLocaleString('id-ID', { month: 'short', year: 'numeric' });
}

async function loadData() {
  const spinner = document.getElementById('loadingSpinner');
  spinner.style.display = 'block';

  try {
    const res = await fetch(WEB_APP_URL);
    const json = await res.json();
    if(!json.success) return;

    const data = json.data;
    const headers = json.headers;

    // Ringkasan
    // Ringkasan
document.getElementById('totalPasien').textContent = data.length;
let dmAda = 0, htAda = 0, tidakAktif = 0;
const desaCounts = {};

data.forEach(r => {
    const diag = (r.Diagnosa || "").toUpperCase().trim();

    // Hitung DM (semua kode mulai E11...)
    if (diag.startsWith("E11")) dmAda++;

    // Hitung HT (semua kode mulai I10...)
    if (diag.startsWith("I10")) htAda++;

    // Hitung Tidak Aktif
    if (r.Status !== "Ada") {
        tidakAktif++;
    }

    // Hitung Desa
    const desaNormalized = r.Desa ? r.Desa.trim().toLowerCase() : "";
    const desa = fixedDesaOrder.find(d => d.toLowerCase() === desaNormalized) || "Lainnya";
    desaCounts[desa] = (desaCounts[desa] || 0) + 1;
});

document.getElementById('dmAda').textContent = dmAda;
document.getElementById('htAda').textContent = htAda;
document.getElementById('tidakAktif').textContent = tidakAktif;

    // Tabel Header
    const headerRow = document.getElementById('headerRow');
    headerRow.innerHTML = '';
    headers.forEach(h=>{
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
    });

    // Tabel Body
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    data.forEach(r=>{
      const tr = document.createElement('tr');
      headers.forEach(h=>{
        const td = document.createElement('td');
        if(h === "Mulai 3Bln" || h === "Akhir 3Bln") {
            td.textContent = formatDate(r[h]);
        } else {
            td.textContent = r[h];
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    // DataTable
    if ($.fn.DataTable.isDataTable('#dataTable')) {
        $('#dataTable').DataTable().destroy();
    }
    const table = $('#dataTable').DataTable({ 
      paging:true, searching:true, info:true, responsive:true 
    });

    // Filter Status
    $('#statusFilter').on('change', function(){
      table.column(headers.indexOf("Status")).search(this.value).draw();
    });

    // Grafik Desa
    const chartLabels = [...fixedDesaOrder, "Lainnya"];
    const chartData = [...fixedDesaOrder.map(d=>desaCounts[d]||0), desaCounts["Lainnya"]||0];
    const ctx = document.getElementById('chartDesa').getContext('2d');
    if(window.desaChart) window.desaChart.destroy(); // reset jika reload
    window.desaChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Jumlah Pasien',
                data: chartData,
                backgroundColor: ['#0d6efd','#6f42c1','#198754','#fd7e14','#0dcaf0','#ffc107','#dc3545','#adb5bd']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Jumlah Pasien per Desa' }
            },
            scales: { y: { beginAtZero: true } }
        }
    });

  } catch(e) {
    console.error(e);
  } finally {
    spinner.style.display = 'none';
  }
}

loadData();


// === Donut (JSONP) ===
const WEB_APP_URL_DONUT = "https://script.google.com/macros/s/AKfycbzVnsB5W5h1y0Yn1pGBYnAKe8A3bBDcQv6dJRgNF6FKX5ertTe7a5M8UWzJuZMS7NTZ9g/exec";

function loadJsonp(url, callbackName) {
  return new Promise(resolve => {
    window[callbackName] = data => resolve(data);
    const script = document.createElement("script");
    script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + callbackName;
    document.body.appendChild(script);
  });
}

async function loadDonut() {
  try {
    const res = await loadJsonp(WEB_APP_URL_DONUT, "donutCallback");
    // dukung dua bentuk respons: array langsung atau {data:[...]}
    const rows = Array.isArray(res) ? res : (res.data || []);

    const labels = rows.map(d => `${d.label} (${d.value})`);
    const values = rows.map(d => Number(d.value) || 0);

    const ctx = document.getElementById('donutChart').getContext('2d');

    if (window.donutChart && typeof window.donutChart.destroy === "function") {
      window.donutChart.destroy();
    }

    window.donutChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: ["#0d6efd", "#dc3545", "#ffc107", "#198754"],
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: function(context) {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const value = context.parsed;
                const pct = total ? ((value / total) * 100).toFixed(1) : "0.0";
                return `${context.label}: ${value} (${pct}%)`;
              }
            }
          }
        },
        cutout: "60%" // tampilkan donut lebih proporsional
      }
    });
  } catch (e) {
    console.error("Donut error:", e);
  }
}

loadDonut();

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
